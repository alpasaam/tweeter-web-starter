AWSTemplateFormatVersion: "2010-09-09"
Transform: AWS::Serverless-2016-10-31
Description: SAM config for Tweeter server

#
# Global Lambda function properties. These apply to every Lambda function.
#
Globals:
  Function:
    Runtime: nodejs20.x
    CodeUri: ./dist/
    Layers:
      - !Ref tweeterLayer
    Timeout: 30
    MemorySize: 128

#
# Reusable blocks of configuration. These are referenced throughout the template to avoid duplication.
# &identifier is used to define a reusable block, and *identifier is used to reference it.
#
Metadata:
  x-common-policies: &commonPolicies
    - AWSLambdaBasicExecutionRole
    - AmazonSESFullAccess
    - CloudWatchFullAccess
    - AmazonDynamoDBFullAccess
    - AmazonS3FullAccess
    - AmazonSQSFullAccess

  x-common-cors-headers: &commonCorsHeaders
    method.response.header.Access-Control-Allow-Origin: "'*'"

  x-common-swagger-response-headers: &commonSwaggerResponseHeaders
    Access-Control-Allow-Origin:
      type: string

#
# AWS resource definitions
#
Resources:
  #
  # Web API
  #

  tweeterApi:
    Type: AWS::Serverless::Api
    Properties:
      Name: tweeterApi
      StageName: prod
      Cors:
        AllowMethods: "'GET,POST,PUT,DELETE'"
        AllowHeaders: "'*'"
        AllowOrigin: "'*'"
      DefinitionBody:
        swagger: "2.0"
        info:
          title: "Tweeter API"
          version: "1.0"
        x-common-consumes: &commonConsumes
          - application/json
        x-common-produces: &commonProduces
          - application/json
        x-common-request-templates: &commonRequestTemplates
          application/json: $input.json('$')
        x-common-amazon-responses: &commonAmazonResponses
          default:
            statusCode: 200
            responseParameters: *commonCorsHeaders
          ".*bad-request.*":
            statusCode: 400
            responseParameters: *commonCorsHeaders
            responseTemplates:
              application/json: '{ "error": "$input.path(''$.errorMessage'')" }'
          ".*unauthorized.*":
            statusCode: 401
            responseParameters: *commonCorsHeaders
            responseTemplates:
              application/json: '{ "error": "$input.path(''$.errorMessage'')" }'
          ".*internal-server-error.*":
            statusCode: 500
            responseParameters: *commonCorsHeaders
            responseTemplates:
              application/json: '{ "error": "$input.path(''$.errorMessage'')" }'
        x-common-swagger-responses: &commonSwaggerResponses
          "200":
            description: "OK"
            headers: *commonSwaggerResponseHeaders
          "400":
            description: "Bad Request"
            headers: *commonSwaggerResponseHeaders
          "401":
            description: "Unauthorized"
            headers: *commonSwaggerResponseHeaders
          "500":
            description: "Internal Server Error"
            headers: *commonSwaggerResponseHeaders
        paths:
          #
          # Endpoint definitions
          #

          /user/getUser: ##### TODO: Change "/user/getUser" to the actual endpoint URL
            post:
              consumes: *commonConsumes
              produces: *commonProduces
              x-amazon-apigateway-integration:
                type: aws
                httpMethod: POST
                uri:
                  ##### TODO: Change "getUserLambda" to the actual function name. (Don't delete the $, {}, or .Arn suffix.)
                  ##### The function name must agree with the "Web API Lambda functions" section below.
                  Fn::Sub: arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${getUserLambda.Arn}/invocations
                requestTemplates: *commonRequestTemplates
                responses: *commonAmazonResponses
              responses: *commonSwaggerResponses

          /user/login: ##### TODO: Set endpoint URL
            post:
              consumes: *commonConsumes
              produces: *commonProduces
              x-amazon-apigateway-integration:
                type: aws
                httpMethod: POST
                uri:
                  ##### TODO: Set function name
                  Fn::Sub: arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${loginLambda.Arn}/invocations
                requestTemplates: *commonRequestTemplates
                responses: *commonAmazonResponses
              responses: *commonSwaggerResponses

          /user/register: ##### TODO: Set endpoint URL
            post:
              consumes: *commonConsumes
              produces: *commonProduces
              x-amazon-apigateway-integration:
                type: aws
                httpMethod: POST
                uri:
                  ##### TODO: Set function name
                  Fn::Sub: arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${registerLambda.Arn}/invocations
                requestTemplates: *commonRequestTemplates
                responses: *commonAmazonResponses
              responses: *commonSwaggerResponses

          /user/logout: ##### TODO: Set endpoint URL
            post:
              consumes: *commonConsumes
              produces: *commonProduces
              x-amazon-apigateway-integration:
                type: aws
                httpMethod: POST
                uri:
                  ##### TODO: Set function name
                  Fn::Sub: arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${logoutLambda.Arn}/invocations
                requestTemplates: *commonRequestTemplates
                responses: *commonAmazonResponses
              responses: *commonSwaggerResponses

          #
          # TODO: ADD MORE ENDPOINT DEFINITIONS HERE
          #

          /follow/getFollowees: ##### TODO: Change "/user/get" to the actual endpoint URL
            post:
              consumes: *commonConsumes
              produces: *commonProduces
              x-amazon-apigateway-integration:
                type: aws
                httpMethod: POST
                uri:
                  ##### TODO: Change "userGetFunction" to the actual function name. (Don't delete the $, {}, or .Arn suffix.)
                  ##### The function name must agree with the "Web API Lambda functions" section below.
                  Fn::Sub: arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${getFolloweesLambda.Arn}/invocations
                requestTemplates: *commonRequestTemplates
                responses: *commonAmazonResponses
              responses: *commonSwaggerResponses

          /follow/getFollowers:
            post:
              consumes: *commonConsumes
              produces: *commonProduces
              x-amazon-apigateway-integration:
                type: aws
                httpMethod: POST
                uri:
                  Fn::Sub: arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${getFollowersLambda.Arn}/invocations
                requestTemplates: *commonRequestTemplates
                responses: *commonAmazonResponses
              responses: *commonSwaggerResponses

          /follow/getFolloweeCount:
            post:
              consumes: *commonConsumes
              produces: *commonProduces
              x-amazon-apigateway-integration:
                type: aws
                httpMethod: POST
                uri:
                  Fn::Sub: arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${getFolloweeCountLambda.Arn}/invocations
                requestTemplates: *commonRequestTemplates
                responses: *commonAmazonResponses
              responses: *commonSwaggerResponses

          /follow/getFollowerCount:
            post:
              consumes: *commonConsumes
              produces: *commonProduces
              x-amazon-apigateway-integration:
                type: aws
                httpMethod: POST
                uri:
                  Fn::Sub: arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${getFollowerCountLambda.Arn}/invocations
                requestTemplates: *commonRequestTemplates
                responses: *commonAmazonResponses
              responses: *commonSwaggerResponses

          /follow/getIsFollowerStatus:
            post:
              consumes: *commonConsumes
              produces: *commonProduces
              x-amazon-apigateway-integration:
                type: aws
                httpMethod: POST
                uri:
                  Fn::Sub: arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${getIsFollowerStatusLambda.Arn}/invocations
                requestTemplates: *commonRequestTemplates
                responses: *commonAmazonResponses
              responses: *commonSwaggerResponses

          /follow/follow:
            post:
              consumes: *commonConsumes
              produces: *commonProduces
              x-amazon-apigateway-integration:
                type: aws
                httpMethod: POST
                uri:
                  Fn::Sub: arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${followLambda.Arn}/invocations
                requestTemplates: *commonRequestTemplates
                responses: *commonAmazonResponses
              responses: *commonSwaggerResponses

          /follow/unfollow:
            post:
              consumes: *commonConsumes
              produces: *commonProduces
              x-amazon-apigateway-integration:
                type: aws
                httpMethod: POST
                uri:
                  Fn::Sub: arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${unfollowLambda.Arn}/invocations
                requestTemplates: *commonRequestTemplates
                responses: *commonAmazonResponses
              responses: *commonSwaggerResponses

          /status/loadMoreFeedItems:
            post:
              consumes: *commonConsumes
              produces: *commonProduces
              x-amazon-apigateway-integration:
                type: aws
                httpMethod: POST
                uri:
                  Fn::Sub: arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${loadMoreFeedItemsLambda.Arn}/invocations
                requestTemplates: *commonRequestTemplates
                responses: *commonAmazonResponses
              responses: *commonSwaggerResponses

          /status/loadMoreStoryItems:
            post:
              consumes: *commonConsumes
              produces: *commonProduces
              x-amazon-apigateway-integration:
                type: aws
                httpMethod: POST
                uri:
                  Fn::Sub: arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${loadMoreStoryItemsLambda.Arn}/invocations
                requestTemplates: *commonRequestTemplates
                responses: *commonAmazonResponses
              responses: *commonSwaggerResponses

          /status/postStatus:
            post:
              consumes: *commonConsumes
              produces: *commonProduces
              x-amazon-apigateway-integration:
                type: aws
                httpMethod: POST
                uri:
                  Fn::Sub: arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${postStatusLambda.Arn}/invocations
                requestTemplates: *commonRequestTemplates
                responses: *commonAmazonResponses
              responses: *commonSwaggerResponses

  #
  # SQS Queues for async feed processing
  #

  PostStatusQueue:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: PostStatusQueue
      MessageRetentionPeriod: 345600 # 4 days
      VisibilityTimeout: 300 # 5 minutes
      ReceiveMessageWaitTimeSeconds: 0
      RedrivePolicy:
        deadLetterTargetArn: !GetAtt PostStatusDLQ.Arn
        maxReceiveCount: 3 # Retry 3 times

  PostStatusDLQ:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: PostStatusDLQ
      MessageRetentionPeriod: 1209600 # 14 days

  FeedUpdateQueue:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: FeedUpdateQueue
      MessageRetentionPeriod: 345600 # 4 days
      VisibilityTimeout: 300 # 5 minutes
      ReceiveMessageWaitTimeSeconds: 0
      RedrivePolicy:
        deadLetterTargetArn: !GetAtt FeedUpdateDLQ.Arn
        maxReceiveCount: 3 # Retry 3 times

  FeedUpdateDLQ:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: FeedUpdateDLQ
      MessageRetentionPeriod: 1209600 # 14 days for DLQ

  #
  # Lambda Layer (reused by all Lambda functions)
  #
  tweeterLayer:
    Type: AWS::Serverless::LayerVersion
    Properties:
      LayerName: tweeterLayer
      Description: dependencies layer for Tweeter server
      ContentUri: ./layer/
      CompatibleRuntimes:
        - nodejs20.x
      RetentionPolicy: DELETE

  #
  # Web API Lambda functions
  #

  ##### TODO: Change "getUserLambda" to the actual function name.
  ##### It must match the function name in the "Endpoint definitons" section above.
  getUserLambda:
    Type: AWS::Serverless::Function
    Properties:
      ##### TODO: Change "getUserLambda" to the actual function name.
      FunctionName: getUserLambda
      ##### TODO: Modify Handler property to match your code. This identifies the exact function that the lambda should run.
      Handler: lambda/user/GetUserLambda.handler
      Policies: *commonPolicies
      Events:
        PostApi:
          Type: Api
          Properties:
            RestApiId: !Ref tweeterApi
            ##### TODO: Modify the Path property to the actual endpoint URL.
            ##### It must match the URL in the "Endpoint definitions" section above.
            Path: /user/getUser
            Method: POST

  loginLambda: ##### TODO: Set function name
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: loginLambda ##### TODO: Set function name
      Handler: lambda/user/LoginLambda.handler ##### TODO: Set Handler
      Policies: *commonPolicies
      Events:
        PostApi:
          Type: Api
          Properties:
            RestApiId: !Ref tweeterApi
            Path: /user/login ##### TODO: Set Path
            Method: POST

  registerLambda: ##### TODO: Set function name
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: registerLambda ##### TODO: Set function name
      Handler: lambda/user/RegisterLambda.handler ##### TODO: Set Handler
      Policies: *commonPolicies
      Events:
        PostApi:
          Type: Api
          Properties:
            RestApiId: !Ref tweeterApi
            Path: /user/register ##### TODO: Set Path
            Method: POST

  logoutLambda: ##### TODO: Set function name
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: logoutLambda ##### TODO: Set function name
      Handler: lambda/user/LogoutLambda.handler ##### TODO: Set Handler
      Policies: *commonPolicies
      Events:
        PostApi:
          Type: Api
          Properties:
            RestApiId: !Ref tweeterApi
            Path: /user/logout ##### TODO: Set Path
            Method: POST

  #
  # TODO: ADD MORE WEB API LAMBDA DEFINITIONS HERE
  #
  ##### TODO: Change "userGetFunction" to the actual function name.
  ##### It must match the function name in the "Endpoint definitons" section above.
  getFolloweesLambda:
    Type: AWS::Serverless::Function
    Properties:
      ##### TODO: Change "userGetFunction" to the actual function name.
      FunctionName: getFolloweesLambda
      ##### TODO: Modify Handler property to match your code. This identifies the exact function that the lambda should run.
      Handler: lambda/follow/GetFolloweesLambda.handler
      Policies: *commonPolicies
      Events:
        PostApi:
          Type: Api
          Properties:
            RestApiId: !Ref tweeterApi
            ##### TODO: Modify the Path property to the actual endpoint URL.
            ##### It must match the URL in the "Endpoint definitions" section above.
            Path: /follow/getFollowees
            Method: POST

  getFollowersLambda:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: getFollowersLambda
      Handler: lambda/follow/GetFollowersLambda.handler
      Policies: *commonPolicies
      Events:
        PostApi:
          Type: Api
          Properties:
            RestApiId: !Ref tweeterApi
            Path: /follow/getFollowers
            Method: POST

  getFolloweeCountLambda:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: getFolloweeCountLambda
      Handler: lambda/follow/GetFolloweeCountLambda.handler
      Policies: *commonPolicies
      Events:
        PostApi:
          Type: Api
          Properties:
            RestApiId: !Ref tweeterApi
            Path: /follow/getFolloweeCount
            Method: POST

  getFollowerCountLambda:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: getFollowerCountLambda
      Handler: lambda/follow/GetFollowerCountLambda.handler
      Policies: *commonPolicies
      Events:
        PostApi:
          Type: Api
          Properties:
            RestApiId: !Ref tweeterApi
            Path: /follow/getFollowerCount
            Method: POST

  getIsFollowerStatusLambda:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: getIsFollowerStatusLambda
      Handler: lambda/follow/GetIsFollowerStatusLambda.handler
      Policies: *commonPolicies
      Events:
        PostApi:
          Type: Api
          Properties:
            RestApiId: !Ref tweeterApi
            Path: /follow/getIsFollowerStatus
            Method: POST

  followLambda:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: followLambda
      Handler: lambda/follow/FollowLambda.handler
      Policies: *commonPolicies
      Events:
        PostApi:
          Type: Api
          Properties:
            RestApiId: !Ref tweeterApi
            Path: /follow/follow
            Method: POST

  unfollowLambda:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: unfollowLambda
      Handler: lambda/follow/UnfollowLambda.handler
      Policies: *commonPolicies
      Events:
        PostApi:
          Type: Api
          Properties:
            RestApiId: !Ref tweeterApi
            Path: /follow/unfollow
            Method: POST

  loadMoreFeedItemsLambda:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: loadMoreFeedItemsLambda
      Handler: lambda/status/LoadMoreFeedItemsLambda.handler
      Policies: *commonPolicies
      Events:
        PostApi:
          Type: Api
          Properties:
            RestApiId: !Ref tweeterApi
            Path: /status/loadMoreFeedItems
            Method: POST

  loadMoreStoryItemsLambda:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: loadMoreStoryItemsLambda
      Handler: lambda/status/LoadMoreStoryItemsLambda.handler
      Policies: *commonPolicies
      Events:
        PostApi:
          Type: Api
          Properties:
            RestApiId: !Ref tweeterApi
            Path: /status/loadMoreStoryItems
            Method: POST

  postStatusLambda:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: postStatusLambda
      Handler: lambda/status/PostStatusLambda.handler
      Timeout: 300
      Policies: *commonPolicies
      Environment:
        Variables:
          POST_STATUS_QUEUE_NAME: PostStatusQueue
      Events:
        PostApi:
          Type: Api
          Properties:
            RestApiId: !Ref tweeterApi
            Path: /status/postStatus
            Method: POST

  #
  # SQS Queue Lambda Functions
  #

  PostStatusQueueProcessor:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: PostStatusQueueProcessor
      Handler: lambda/queue/PostStatusQueueProcessor.handler
      Timeout: 300
      Policies: *commonPolicies
      Environment:
        Variables:
          FEED_UPDATE_QUEUE_NAME: FeedUpdateQueue
      Events:
        SQSTrigger:
          Type: SQS
          Properties:
            Queue: !GetAtt PostStatusQueue.Arn
            BatchSize: 1 # Process one status post at a time
            Enabled: true

  FeedUpdateQueueProcessor:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: FeedUpdateQueueProcessor
      Handler: lambda/queue/FeedUpdateQueueProcessor.handler
      Timeout: 300
      Policies: *commonPolicies
      Events:
        SQSTrigger:
          Type: SQS
          Properties:
            Queue: !GetAtt FeedUpdateQueue.Arn
            BatchSize: 10 # Process up to 10 messages at once (SQS best practice)
            MaximumBatchingWindowInSeconds: 5 # Wait up to 5 seconds to batch messages
            Enabled: true

  #
  # DynamoDB Tables
  #

  userTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: user
      AttributeDefinitions:
        - AttributeName: alias
          AttributeType: S
      KeySchema:
        - AttributeName: alias
          KeyType: HASH
      BillingMode: PROVISIONED
      ProvisionedThroughput:
        ReadCapacityUnits: 1
        WriteCapacityUnits: 1

  authTokenTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: authToken
      AttributeDefinitions:
        - AttributeName: token
          AttributeType: S
      KeySchema:
        - AttributeName: token
          KeyType: HASH
      BillingMode: PROVISIONED
      ProvisionedThroughput:
        ReadCapacityUnits: 1
        WriteCapacityUnits: 1

  followTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: follow
      AttributeDefinitions:
        - AttributeName: follower_alias
          AttributeType: S
        - AttributeName: followee_alias
          AttributeType: S
      KeySchema:
        - AttributeName: follower_alias
          KeyType: HASH
        - AttributeName: followee_alias
          KeyType: RANGE
      BillingMode: PROVISIONED
      ProvisionedThroughput:
        ReadCapacityUnits: 1
        WriteCapacityUnits: 1
      GlobalSecondaryIndexes:
        - IndexName: follow_index
          KeySchema:
            - AttributeName: followee_alias
              KeyType: HASH
            - AttributeName: follower_alias
              KeyType: RANGE
          ProvisionedThroughput:
            ReadCapacityUnits: 1
            WriteCapacityUnits: 1
          Projection:
            ProjectionType: ALL

  statusTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: status
      AttributeDefinitions:
        - AttributeName: user_alias
          AttributeType: S
        - AttributeName: timestamp
          AttributeType: N
      KeySchema:
        - AttributeName: user_alias
          KeyType: HASH
        - AttributeName: timestamp
          KeyType: RANGE
      BillingMode: PROVISIONED
      ProvisionedThroughput:
        ReadCapacityUnits: 1
        WriteCapacityUnits: 1

  feedTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: feed
      AttributeDefinitions:
        - AttributeName: user_alias
          AttributeType: S
        - AttributeName: timestamp
          AttributeType: N
      KeySchema:
        - AttributeName: user_alias
          KeyType: HASH
        - AttributeName: timestamp
          KeyType: RANGE
      BillingMode: PROVISIONED
      ProvisionedThroughput:
        ReadCapacityUnits: 1
        WriteCapacityUnits: 1

  #
  # S3 Bucket for Profile Images
  # Note: Bucket created manually: tweeter-profile-images-saam
  #
